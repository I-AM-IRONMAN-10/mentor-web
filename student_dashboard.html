<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MentorMatch - Student Dashboard (Rathi)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <nav class="bg-white shadow-lg p-4 flex justify-between items-center sticky top-0 z-10">
    <h1 class="text-2xl font-extrabold text-indigo-600">MentorMatch</h1>
    <div class="flex items-center space-x-4">
        <span class="text-gray-700 font-medium">Welcome, Rathi!</span>
        <button id="logout-button" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-150">Logout</button>
    </div>
  </nav>

  <main class="p-6 md:p-10">
    <div class="space-y-8">
        
      <div class="bg-white p-6 rounded-xl shadow-2xl border-l-4 border-indigo-500">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Your Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-gray-600">
            <div>
                <p class="font-semibold text-sm text-indigo-500">Student Name</p>
                <p class="text-lg">Rathi</p>
            </div>
            <div>
                <p class="font-semibold text-sm text-indigo-500">Roll Number</p>
                <p class="text-lg">24aids088</p>
            </div>
            <div>
                <p class="font-semibold text-sm text-indigo-500">Mentor</p>
                <p class="text-lg">Priya</p>
            </div>
        </div>
        
        <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-indigo-200">
            <h3 class="text-lg font-bold text-indigo-700 mb-3">Upload Profile Photo</h3>
            <div class="flex items-center space-x-4">
                <img id="profile-photo-display" 
                     class="w-20 h-20 rounded-full object-cover border-2 border-indigo-500"
                     src="https://via.placeholder.com/80/E0E7FF/4F46E5?text=Rathi" 
                     alt="Student Profile Photo">
                <div>
                    <input type="file" id="photo-file-input" accept="image/*" class="text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                    <p id="upload-status" class="text-xs mt-2 text-gray-500"></p>
                </div>
            </div>
        </div>

      </div>

      <div class="bg-white p-6 rounded-xl shadow-2xl border-l-4 border-purple-500">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Questions from Staff</h2>
        <div id="loading-staff-questions" class="text-center text-gray-500 py-2">Loading staff questions...</div>
        <div id="staff-questions-list" class="space-y-4">
            </div>
      </div>

      <div class="flex justify-center">
          <div class="bg-white p-8 rounded-xl shadow-2xl border-t-4 border-green-500 w-full max-w-2xl">
              <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Submit Your Query</h2>
              
              <form id="query-form" class="space-y-4">
                <textarea id="query-input" placeholder="Type your academic or project-related query here..." 
                  class="w-full h-32 border border-gray-300 rounded-lg p-4 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                
                <div class="grid grid-cols-2 gap-3">
                    <button type="button" id="normal-submit"
                        class="bg-indigo-600 text-white font-semibold px-2 py-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md text-sm">Send Query (Normal + PDF 📥)</button>

                    <button type="button" id="urgent-submit"
                        class="bg-red-600 text-white font-semibold px-2 py-3 rounded-lg hover:bg-red-700 transition duration-150 shadow-md text-sm">
                        🚨 URGENT (Mail + PDF)
                    </button>
                </div>
              </form>

              <div id="status-message" class="mt-4 text-center text-green-600 font-medium"></div>
          </div>
      </div>
      
      <div class="bg-white p-6 rounded-xl shadow-2xl border-l-4 border-gray-400">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Query History & Mentor Responses</h2>
        <div id="loading-history" class="text-center text-gray-500 py-4">Loading history...</div>
        <div id="query-history-list" class="space-y-6">
        </div>
      </div>

    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, setDoc, doc, getDoc, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
    
    const { jsPDF } = window.jspdf;
    
    const TARGET_STAFF_EMAIL = "rupavathy.aids@act.edu.in"; 

    // Firebase Config (Placeholder)
    const firebaseConfig = {
      apiKey: "AIzaSyCDjvG08LHJ0ahNwTbl4stG5mJEODP00c8",
      authDomain: "san-mentor.firebaseapp.com",
      projectId: "san-mentor",
      storageBucket: "san-mentor.firebasestorage.app",
      messagingSenderId: "384516195677",
      appId: "1:384516195677:web:e0224b177c9ad04f3e14b4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app); 

    const queryInput = document.getElementById("query-input");
    const normalSubmitButton = document.getElementById("normal-submit");
    const urgentSubmitButton = document.getElementById("urgent-submit");
    const statusMessage = document.getElementById("status-message");
    const queryHistoryList = document.getElementById("query-history-list");
    const loadingHistory = document.getElementById("loading-history");
    const staffQuestionsList = document.getElementById("staff-questions-list");
    const loadingStaffQuestions = document.getElementById("loading-staff-questions");
    const photoFileInput = document.getElementById("photo-file-input");
    const profilePhotoDisplay = document.getElementById("profile-photo-display");
    const uploadStatus = document.getElementById("upload-status");

    // Hardcoded student and mentor details
    const currentStudent = {
      uid: "24aids088-rathi-test-id", 
      name: "Rathi",
      email: "rathi.24aids088@test-student.com", 
      roleNumber: "24aids088", 
      mentorName: "Priya",
      mentorEmail: "priya.mentor@test-org.com"
    };

    /**
     * Generates and downloads the query text as a PDF.
     */
    function exportQueryAsPdf(studentName, queryText, mentorName, rollNumber, isUrgent = false) {
        const doc = new jsPDF();
        const timestamp = new Date().toLocaleString();
        
        const title = isUrgent ? "MENTORMATCH URGENT QUERY RECEIPT" : "MENTORMATCH QUERY RECEIPT";

        let yPos = 20;
        doc.setFontSize(18);
        doc.text(title, 105, yPos, { align: "center" });
        yPos += 10;
        doc.line(20, yPos, 190, yPos);
        yPos += 10;
        doc.setFontSize(12);
        doc.text(`Student: ${studentName} (Roll: ${rollNumber})`, 20, yPos);
        yPos += 7;
        doc.text(`Mentor: ${mentorName}`, 20, yPos);
        yPos += 7;
        doc.text(`Date & Time: ${timestamp}`, 20, yPos);
        yPos += 15;
        doc.setFontSize(14);
        doc.text(`Submitted Query (${isUrgent ? 'URGENT' : 'NORMAL'}):`, 20, yPos);
        yPos += 8;
        doc.setFontSize(11);
        const splitText = doc.splitTextToSize(queryText, 170);
        doc.text(splitText, 20, yPos);
        
        const filename = `${studentName.toLowerCase().replace(/\s/g, '-')}_${isUrgent ? 'URGENT' : 'NORMAL'}_query_${Date.now()}.pdf`;
        
        doc.save(filename); 
        return filename;
    }


    /**
     * Handles the common logic for saving the query to Firebase and updating the count.
     */
    async function submitToFirebase(queryText) {
        const studentDocRef = doc(db, "students", currentStudent.uid);
        
        // 1. Add query to the "queries" subcollection
        await addDoc(collection(db, "students", currentStudent.uid, "queries"), {
          text: queryText,
          timestamp: serverTimestamp(),
          mentorEmail: currentStudent.mentorEmail,
          studentName: currentStudent.name,
          studentEmail: currentStudent.email,
        });

        // 2. Update Query Count
        const studentSnap = await getDoc(studentDocRef);
        const currentQueryCount = studentSnap.exists() ? (studentSnap.data().queryCount || 0) : 0;
        const newQueryCount = currentQueryCount + 1;

        await setDoc(studentDocRef, {
          name: currentStudent.name,
          email: currentStudent.email,
          mentorEmail: currentStudent.mentorEmail,
          roleNumber: currentStudent.roleNumber, 
          queryCount: newQueryCount, 
          timestamp: serverTimestamp()
        }, { merge: true });

        return newQueryCount;
    }
    
    // --- Photo Upload Logic (from previous step) ---
    async function uploadPhoto() {
        const file = photoFileInput.files[0];
        if (!file) return;
        uploadStatus.textContent = "Uploading... please wait.";
        uploadStatus.className = "text-xs mt-2 text-yellow-600";
        const photoRef = ref(storage, `students/${currentStudent.uid}/profile_${currentStudent.roleNumber}.jpg`);
        try {
            const snapshot = await uploadBytes(photoRef, file);
            const photoURL = await getDownloadURL(snapshot.ref);
            const studentDocRef = doc(db, "students", currentStudent.uid);
            await setDoc(studentDocRef, { photoURL: photoURL }, { merge: true });
            profilePhotoDisplay.src = photoURL;
            uploadStatus.textContent = "Photo uploaded and saved successfully! ✅";
            uploadStatus.className = "text-xs mt-2 text-green-600 font-semibold";
        } catch (error) {
            console.error("Error uploading photo:", error);
            uploadStatus.textContent = `Upload failed: ${error.message}`;
            uploadStatus.className = "text-xs mt-2 text-red-600 font-semibold";
        }
    }

    async function loadProfilePhoto() {
        try {
            const studentDocRef = doc(db, "students", currentStudent.uid);
            const studentSnap = await getDoc(studentDocRef);
            if (studentSnap.exists() && studentSnap.data().photoURL) {
                profilePhotoDisplay.src = studentSnap.data().photoURL;
            }
        } catch (error) {
            console.error("Error loading profile photo:", error);
        }
    }
    // --------------------------------------------------

    // --- loadQueryHistory and loadStaffQuestions functions ---
    async function loadQueryHistory() {
        queryHistoryList.innerHTML = ''; 
        loadingHistory.style.display = 'block'; 
        try {
            const queriesRef = collection(db, "students", currentStudent.uid, "queries");
            const q = query(queriesRef, orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                queryHistoryList.innerHTML = '<p class="text-gray-500 italic">No queries submitted yet.</p>';
            } else {
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const timestamp = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A';
                    const mentorResponse = data.response || "No response yet.";
                    const responseClass = data.response ? 'bg-blue-50 border-blue-300' : 'bg-yellow-50 border-yellow-300';
                    const queryItem = `
                        <div class="border rounded-lg p-4 shadow-sm">
                            <p class="text-xs text-gray-500 mb-2">Submitted on: ${timestamp}</p>
                            <div class="border-l-4 border-indigo-500 pl-3 mb-4">
                                <p class="font-semibold text-indigo-700">Your Query:</p>
                                <p class="text-gray-800">${data.text}</p>
                            </div>
                            <div class="p-3 rounded-md ${responseClass}">
                                <p class="font-semibold text-sm mb-1 text-gray-700">Mentor Priya's Response:</p>
                                <p class="text-gray-700 italic">${mentorResponse}</p>
                            </div>
                        </div>
                    `;
                    queryHistoryList.innerHTML += queryItem;
                });
            }
        } catch (error) {
            console.error("Error loading query history:", error);
            queryHistoryList.innerHTML = '<p class="text-red-500">Failed to load query history.</p>';
        } finally {
            loadingHistory.style.display = 'none'; 
        }
    }
    async function loadStaffQuestions() {
        staffQuestionsList.innerHTML = ''; 
        loadingStaffQuestions.style.display = 'block'; 
        try {
            const staffQuestionsRef = collection(db, "staffQuestions");
            const q = query(staffQuestionsRef, 
                            where("targetUid", "==", currentStudent.uid),
                            orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                staffQuestionsList.innerHTML = '<p class="text-gray-500 italic">No questions from staff at this time.</p>';
            } else {
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const timestamp = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A';
                    const staffName = data.staffName || "Unknown Staff Member";
                    const questionItem = `
                        <div class="border rounded-lg p-4 bg-purple-50 shadow-sm border-l-4 border-purple-500">
                            <p class="text-xs text-gray-600 mb-2">From: ${staffName} | Asked on: ${timestamp}</p>
                            <p class="font-bold text-purple-800">Question:</p>
                            <p class="text-gray-800">${data.questionText}</p>
                            <button class="mt-3 bg-purple-600 text-white text-xs px-3 py-1 rounded hover:bg-purple-700" disabled>
                                Respond (Future Feature)
                            </button>
                        </div>
                    `;
                    staffQuestionsList.innerHTML += questionItem;
                });
            }
        } catch (error) {
            console.error("Error loading staff questions:", error);
            staffQuestionsList.innerHTML = '<p class="text-red-500">Failed to load staff questions.</p>';
        } finally {
            loadingStaffQuestions.style.display = 'none'; 
        }
    }
    // -------------------------------------------------------------------------


    // --- Event Listener for NORMAL SUBMISSION (NOW AUTO-DOWNLOADS PDF) ---
    normalSubmitButton.addEventListener("click", async (e) => {
        e.preventDefault();
        const queryText = queryInput.value.trim();
        if (!queryText) {
            statusMessage.textContent = "❌ Please enter a query!";
            statusMessage.className = "mt-4 text-center text-red-600 font-medium";
            return;
        }

        statusMessage.textContent = "Sending query and preparing PDF receipt, please wait...";
        statusMessage.className = "mt-4 text-center text-yellow-600 font-medium";

        try {
            // 1. Save to Firebase DB
            const newQueryCount = await submitToFirebase(queryText);
            
            // 2. Generate and Download PDF automatically
            exportQueryAsPdf(currentStudent.name, queryText, currentStudent.mentorName, currentStudent.roleNumber, false);
            
            queryInput.value = "";
            statusMessage.textContent = `✅ Query Accepted! Normal message sent, and PDF receipt downloaded. Total Queries: ${newQueryCount}`;
            statusMessage.className = "mt-4 text-center text-green-600 font-bold";
            alert(`✅ Query Accepted! Normal message sent, and PDF receipt **automatically downloaded**.`);
            
            loadQueryHistory(); 

        } catch (error) {
            console.error("Error sending query:", error);
            statusMessage.textContent = "❌ Query Not Accepted! Failed to process and save.";
            statusMessage.className = "mt-4 text-center text-red-600 font-bold";
            alert("❌ Query Not Accepted! Failed to send query.");
        }
    });

    // --- Event Listener for URGENT SUBMISSION (Mailto Redirection + PDF) ---
    urgentSubmitButton.addEventListener("click", async (e) => {
        e.preventDefault();
        const queryText = queryInput.value.trim();
        if (!queryText) {
            statusMessage.textContent = "❌ Please enter a query!";
            statusMessage.className = "mt-4 text-center text-red-600 font-medium";
            return;
        }

        statusMessage.textContent = "🚨 Processing URGENT request: Saving to DB, downloading PDF, and opening mail client...";
        statusMessage.className = "mt-4 text-center text-red-600 font-bold";

        try {
            // 1. Save to Firebase DB
            await submitToFirebase(queryText);

            // 2. Generate PDF and download it (for manual attachment)
            exportQueryAsPdf(currentStudent.name, queryText, currentStudent.mentorName, currentStudent.roleNumber, true); // true for isUrgent
            
            // 3. Construct Mailto Link for Redirection
            const subject = encodeURIComponent(`URGENT QUERY from ${currentStudent.name} (${currentStudent.roleNumber})`);
            const body = encodeURIComponent(`Dear Staff,\n\nThis is an urgent query from me, ${currentStudent.name} (Roll No: ${currentStudent.roleNumber}).\n\nQuery Details:\n\n${queryText}\n\nI have attached the PDF receipt of this query for your records.\n\nThank you.`);

            const mailtoLink = `mailto:${TARGET_STAFF_EMAIL}?cc=${currentStudent.email}&subject=${subject}&body=${body}`;

            // 4. Update status and redirect
            queryInput.value = "";
            statusMessage.textContent = `✅ URGENT Query saved to DB. Opening your mail client now...`;
            statusMessage.className = "mt-4 text-center text-green-600 font-bold";
            
            alert(`✅ URGENT Query saved to DB and PDF **downloaded**. Your mail client will now open to send the message to **${TARGET_STAFF_EMAIL}**. \n\n***ACTION REQUIRED:*** Please **manually attach** the downloaded PDF file to the email before clicking Send.`);

            window.location.href = mailtoLink;
            loadQueryHistory();

        } catch (error) {
            console.error("Error processing URGENT query:", error);
            statusMessage.textContent = "❌ URGENT Query Failed! Please check your query and connection.";
            statusMessage.className = "mt-4 text-center text-red-600 font-bold";
            alert("❌ URGENT Query Failed! The query was saved to the DB, but the mail client could not be opened automatically.");
        }
    });

    // --- Photo upload listener ---
    photoFileInput.addEventListener("change", uploadPhoto);
    
    // Logout
    document.getElementById('logout-button').addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      window.location.href = './index.html'; 
    });

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        loadQueryHistory();
        loadStaffQuestions();
        loadProfilePhoto(); 
    });
  </script>
</body>
</html>