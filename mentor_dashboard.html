<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MentorMatch - Mentor Dashboard (Rathi's Queries)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <nav class="bg-white shadow-lg p-4 flex justify-between items-center sticky top-0 z-10">
    <h1 class="text-2xl font-extrabold text-green-600">Mentor Dashboard</h1>
    <div class="flex items-center space-x-4">
        <span class="text-gray-700 font-medium">Welcome, Priya!</span>
        <button id="logout-button" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-150">Logout</button>
    </div>
  </nav>

  <main class="p-6 md:p-10">
    <div class="space-y-8">
        
      <div class="bg-white p-6 rounded-xl shadow-2xl border-l-4 border-indigo-500">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Focused Student: Rathi (24aids088)</h2>
        <p class="text-gray-600">Review Rathi's queries and send new messages.</p>
        <div id="query-count-display" class="mt-3 text-lg font-semibold text-green-600"></div>
      </div>
      
      <div class="bg-white p-6 rounded-xl shadow-2xl border-l-4 border-purple-500">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Send New Message to Rathi</h2>
          <form id="new-message-form" class="space-y-4">
              <textarea id="mentor-message-input" placeholder="Type your question or message for Rathi here..." 
                class="w-full h-24 border border-gray-300 rounded-lg p-3 focus:ring-purple-500 focus:border-purple-500 transition duration-150"></textarea>
              <button type="submit" 
                class="w-full bg-purple-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-purple-700 transition duration-150 shadow-md">Send Message to Rathi</button>
          </form>
          <div id="message-status-message" class="mt-4 text-center text-green-600 font-medium"></div>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-2xl border-l-4 border-gray-400">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Rathi's Query History (Student-Initiated)</h2>
        <div id="loading-queries" class="text-center text-gray-500 py-4">Loading Rathi's queries... üîÑ</div>
        <div id="all-queries-list" class="space-y-8">
            </div>
      </div>

    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, setDoc, doc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    
    const { jsPDF } = window.jspdf;

    // Firebase Config (Placeholder)
    const firebaseConfig = {
      apiKey: "AIzaSyCDjvG08LHJ0ahNwTbl4stG5mJEODP00c8",
      authDomain: "san-mentor.firebaseapp.com",
      projectId: "san-mentor",
      storageBucket: "san-mentor.firebasestorage.app",
      messagingSenderId: "384516195677",
      appId: "1:384516195677:web:e0224b177c9ad04f3e14b4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const allQueriesList = document.getElementById("all-queries-list");
    const loadingQueries = document.getElementById("loading-queries");
    const queryCountDisplay = document.getElementById("query-count-display");
    const newMessageForm = document.getElementById("new-message-form");
    const mentorMessageInput = document.getElementById("mentor-message-input");
    const messageStatusMessage = document.getElementById("message-status-message");
    
    // Hardcoded Mentor details
    const currentMentor = {
        email: "priya.mentor@test-org.com",
        name: "Priya"
    };

    // Hardcoded Student Rathi's details
    const targetStudent = {
      uid: "24aids088-rathi-test-id", 
      name: "Rathi",
      email: "rathi.24aids088@test-student.com", 
      roleNumber: "24aids088"
    };

    /**
     * Generates and downloads a PDF archive of the query and mentor response.
     * This function now handles cases where no response exists yet.
     */
    function downloadQueryAsPdf(queryData, queryDocId) {
        const doc = new jsPDF();
        const submittedTime = queryData.timestamp ? new Date(queryData.timestamp.toDate()).toLocaleString() : 'N/A';
        // Ensure responseText is a string, even if null/undefined
        const responseText = queryData.response || "--- No mentor response recorded yet ---";
        
        let yPos = 20;

        doc.setFontSize(18);
        doc.text("Query Conversation Archive", 105, yPos, { align: "center" });
        yPos += 10;
        
        doc.line(20, yPos, 190, yPos);
        yPos += 10;
        
        doc.setFontSize(12);
        doc.text(`Student: ${targetStudent.name} (Roll: ${targetStudent.roleNumber})`, 20, yPos);
        yPos += 7;
        doc.text(`Mentor: ${currentMentor.name}`, 20, yPos);
        yPos += 7;
        doc.text(`Submitted On: ${submittedTime}`, 20, yPos);
        yPos += 15;
        
        // --- Student Query Section ---
        doc.setFontSize(14);
        doc.text("Student Query:", 20, yPos);
        yPos += 8;

        doc.setFontSize(11);
        let splitText = doc.splitTextToSize(queryData.text, 170);
        doc.text(splitText, 20, yPos);
        yPos += (splitText.length * 5) + 10;

        // --- Mentor Response Section ---
        doc.setFontSize(14);
        doc.text("Mentor Response:", 20, yPos);
        yPos += 8;

        doc.setFontSize(11);
        splitText = doc.splitTextToSize(responseText, 170);
        doc.text(splitText, 20, yPos);
        
        const filename = `${targetStudent.name}_Query_${queryDocId.substring(0, 8)}_Archive.pdf`;
        doc.save(filename);

        alert(`‚úÖ PDF Archive downloaded: ${filename}`);
    }


    /**
     * Handles the submission of a mentor response for an existing query document.
     */
    async function handleResponseSubmission(queryDocId, studentUid, responseText) {
        if (!responseText.trim()) {
            alert("Please enter a response.");
            return;
        }

        try {
            const queryRef = doc(db, "students", studentUid, "queries", queryDocId);
            
            await setDoc(queryRef, {
                response: responseText.trim(),
                responseTimestamp: new Date().toISOString(),
                mentorEmail: currentMentor.email 
            }, { merge: true });

            alert("‚úÖ Response sent successfully! Refreshing view.");
            loadStudentQueries(); // Reload to show updated status
        } catch (error) {
            console.error("Error submitting response:", error);
            alert("‚ùå Failed to send response: " + error.message);
        }
    }
    
    /**
     * Handles the submission of a new, unsolicited question from the mentor to the student.
     */
    async function sendNewQuestionToStudent(questionText) {
        messageStatusMessage.textContent = "Sending message, please wait...";
        messageStatusMessage.className = "mt-4 text-center text-yellow-600 font-medium";

        try {
            await addDoc(collection(db, "staffQuestions"), {
                questionText: questionText,
                timestamp: serverTimestamp(),
                targetUid: targetStudent.uid, 
                targetName: targetStudent.name,
                staffName: currentMentor.name,
                staffRole: "Mentor"
            });

            mentorMessageInput.value = "";
            messageStatusMessage.textContent = `‚úÖ Message sent to Rathi successfully!`;
            messageStatusMessage.className = "mt-4 text-center text-green-600 font-bold";

        } catch (error) {
            console.error("Error sending new question:", error);
            messageStatusMessage.textContent = "‚ùå Failed to send message.";
            messageStatusMessage.className = "mt-4 text-center text-red-600 font-bold";
        }
    }


    /**
     * Fetches and displays Rathi's queries (student-initiated).
     */
    async function loadStudentQueries() {
        allQueriesList.innerHTML = ''; 
        loadingQueries.style.display = 'block'; 
        let totalQueries = 0;
        let queryDataMap = {};

        try {
            const queriesRef = collection(db, "students", targetStudent.uid, "queries");
            const q = query(queriesRef, orderBy("timestamp", "desc"));
            const queriesSnapshot = await getDocs(q);

            if (queriesSnapshot.empty) {
                allQueriesList.innerHTML = '<p class="text-gray-500 italic">No queries submitted by Rathi yet.</p>';
            }

            queriesSnapshot.forEach((queryDoc) => {
                const data = queryDoc.data();
                queryDataMap[queryDoc.id] = data; 
                totalQueries++;
                
                const timestamp = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A';
                const mentorResponse = data.response || null;
                
                let responseBlock;
                
                // *** MODIFIED LOGIC: Download button is ALWAYS available ***
                const downloadButton = `
                    <button data-query-id="${queryDoc.id}" class="download-pdf-btn bg-gray-500 text-white px-3 py-1 rounded-lg hover:bg-gray-600 text-sm mt-3 ml-2">
                        Download Conversation PDF üì•
                    </button>
                `;
                
                // Mailto link for direct reply
                const replyMailtoLink = `mailto:${targetStudent.email}?subject=RE: Query from ${targetStudent.name} (${targetStudent.roleNumber})&body=Dear Rathi,\n\nRegarding your query submitted on ${timestamp}:\n\n> ${data.text.substring(0, 100).replace(/\n/g, ' ')}...\n\n[Type your response here]\n\nRegards,\nPriya`;
                const replyButton = `
                    <a href="${replyMailtoLink}" class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 text-sm mt-3 inline-block">
                        Reply via Email üìß
                    </a>
                `;


                if (mentorResponse) {
                    responseBlock = `
                        <div class="mt-4 p-3 rounded-md bg-blue-100 border-l-4 border-blue-500">
                            <p class="font-bold text-blue-800">Your Response:</p>
                            <p class="text-gray-700 italic whitespace-pre-wrap">${mentorResponse}</p>
                        </div>
                    `;
                } else {
                    responseBlock = `
                        <form data-query-id="${queryDoc.id}" data-student-uid="${targetStudent.uid}" class="response-form mt-4 space-y-2">
                            <textarea name="response" placeholder="Type your response here..." class="w-full h-24 border rounded-md p-2 focus:ring-green-500"></textarea>
                            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">Send Response</button>
                        </form>
                    `;
                }

                const queryItem = `
                    <div class="border rounded-xl p-6 shadow-md bg-gray-50">
                        <p class="text-sm font-medium text-indigo-600">Student: ${targetStudent.name} (${targetStudent.roleNumber})</p>
                        <p class="text-xs text-gray-500 mb-3">Submitted on: ${timestamp}</p>
                        
                        <div class="border-l-4 border-indigo-500 pl-3">
                            <p class="font-semibold text-gray-800">Query:</p>
                            <p class="text-gray-700 whitespace-pre-wrap">${data.text}</p>
                        </div>

                        ${responseBlock}
                        <div class="flex mt-3">
                            ${replyButton}
                            ${downloadButton}
                        </div>
                    </div>
                `;
                allQueriesList.innerHTML += queryItem;
            });
            
            queryCountDisplay.textContent = `Total Queries from Rathi: ${totalQueries}`;

            // 3. Attach event listeners
            document.querySelectorAll('.response-form').forEach(form => {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const queryDocId = form.getAttribute('data-query-id');
                    const studentUid = form.getAttribute('data-student-uid');
                    const responseText = form.elements['response'].value;
                    handleResponseSubmission(queryDocId, studentUid, responseText);
                });
            });

            document.querySelectorAll('.download-pdf-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const queryDocId = e.target.getAttribute('data-query-id');
                    downloadQueryAsPdf(queryDataMap[queryDocId], queryDocId);
                });
            });


        } catch (error) {
            console.error("Error loading Rathi's queries:", error);
            allQueriesList.innerHTML = '<p class="text-red-500">Failed to load queries. Check Firebase connection or Rathi\'s UID.</p>';
        } finally {
            loadingQueries.style.display = 'none'; 
        }
    }
    
    // --- Event Listener for NEW MESSAGE SUBMISSION ---
    newMessageForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const questionText = mentorMessageInput.value.trim();
        if (!questionText) {
            messageStatusMessage.textContent = "‚ùå Please enter a message.";
            messageStatusMessage.className = "mt-4 text-center text-red-600 font-medium";
            return;
        }
        sendNewQuestionToStudent(questionText);
    });

    // Logout
    document.getElementById('logout-button').addEventListener('click', () => {
      alert("Logging out Mentor Priya.");
      window.location.href = './index.html'; 
    });

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', loadStudentQueries);
  </script>
</body>
</html>